<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Quantiles, Networks, Time - 9&nbsp; Metropolis-Hastings</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Stemp.html" rel="next">
<link href="./CK.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./QR.html">Quantiles</a></li><li class="breadcrumb-item"><a href="./SMH.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Metropolis-Hastings</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Quantiles, Networks, Time</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Genesis</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Methods matter</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./R2021.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Non-econometric methods for econometricians</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ssm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">State-Space Models: time series models with structure</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./RegressionLemma.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The regression lemma</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Kalman.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Kalman filtering</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Quantiles</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./QR.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Quantile regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Gibbs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Gibbs Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CK.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Carter-Kohn</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./SMH.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Metropolis-Hastings</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Networks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Stemp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Causal Inference</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Maps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping regional house price inflation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Time</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./BK.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Linear rational expectations models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./BVAR.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">BVAR with dummies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Dynare.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Dynare basics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">End matter</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Summary</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Appendix1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Basic <code>ggplot2</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./LinAlg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Linear algebra</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#complicated-densities" id="toc-complicated-densities" class="nav-link active" data-scroll-target="#complicated-densities"><span class="header-section-number">9.1</span> Complicated densities</a>
  <ul class="collapse">
  <li><a href="#target-density" id="toc-target-density" class="nav-link" data-scroll-target="#target-density"><span class="header-section-number">9.1.1</span> Target density</a></li>
  </ul></li>
  <li><a href="#simplified-problem-estimating-known-prior" id="toc-simplified-problem-estimating-known-prior" class="nav-link" data-scroll-target="#simplified-problem-estimating-known-prior"><span class="header-section-number">9.2</span> Simplified problem: estimating (known) prior</a></li>
  <li><a href="#example-1" id="toc-example-1" class="nav-link" data-scroll-target="#example-1"><span class="header-section-number">9.3</span> Example 1</a>
  <ul class="collapse">
  <li><a href="#analytic-densities" id="toc-analytic-densities" class="nav-link" data-scroll-target="#analytic-densities"><span class="header-section-number">9.3.1</span> Analytic densities</a></li>
  <li><a href="#random-draws" id="toc-random-draws" class="nav-link" data-scroll-target="#random-draws"><span class="header-section-number">9.3.2</span> Random draws</a></li>
  </ul></li>
  <li><a href="#estimating-the-marginals-from-the-joint-density" id="toc-estimating-the-marginals-from-the-joint-density" class="nav-link" data-scroll-target="#estimating-the-marginals-from-the-joint-density"><span class="header-section-number">9.4</span> Estimating the marginals from the joint density</a>
  <ul class="collapse">
  <li><a href="#metropolis-hastings" id="toc-metropolis-hastings" class="nav-link" data-scroll-target="#metropolis-hastings"><span class="header-section-number">9.4.1</span> Metropolis-Hastings</a></li>
  <li><a href="#simplification" id="toc-simplification" class="nav-link" data-scroll-target="#simplification"><span class="header-section-number">9.4.2</span> Simplification</a></li>
  </ul></li>
  <li><a href="#a-simpler-problem" id="toc-a-simpler-problem" class="nav-link" data-scroll-target="#a-simpler-problem"><span class="header-section-number">9.5</span> A simpler problem</a>
  <ul class="collapse">
  <li><a href="#estimating-example-1" id="toc-estimating-example-1" class="nav-link" data-scroll-target="#estimating-example-1"><span class="header-section-number">9.5.1</span> Estimating example 1</a></li>
  <li><a href="#example-2" id="toc-example-2" class="nav-link" data-scroll-target="#example-2"><span class="header-section-number">9.5.2</span> Example 2</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Metropolis-Hastings</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="complicated-densities" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="complicated-densities"><span class="header-section-number">9.1</span> Complicated densities</h2>
<p>What if we have a posterior density that is too complicated to factor into a full set of conditional densities? Recall that Gibbs Sampling is a procedure that generates <em>marginal densities</em> from <em>conditional densities</em>. What if we don’t have conditional densities?</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why can’t we use Gibbs for DSGEs?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Say a model only has two unknown parameters, <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\gamma\)</span>. Any predictions of that model conditional on them is: <span class="math display">\[\begin{equation}
  y = f(X,\ \alpha,\ \gamma)
\end{equation}\]</span> The likelihood of that model <span class="math display">\[\begin{equation}
  \mathcal{L}(\alpha,\ \gamma\ | \ y,\ X)
\end{equation}\]</span> is readily available but the conditional density of say, <span class="math inline">\(\alpha\)</span> <span class="math display">\[\begin{equation}
  \mathcal{P}(\alpha\ | \ y,\ X,\ \gamma)
\end{equation}\]</span> typically isn’t. This is because the predictive model <span class="math inline">\(f(\cdot)\)</span> depends on all the parameters through the reduced form solution used in DSGEs even if the underlying model is linear, i.e.&nbsp;the solution in <span class="citation" data-cites="BK1980">(<a href="references.html#ref-BK1980" role="doc-biblioref"><strong>BK1980?</strong></a>)</span>. As <span class="math inline">\(f(X,\ \alpha,\ \gamma)\)</span> <strong><em>always</em></strong> depends on both <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\gamma\)</span> it is difficult to find an appropriate conditional likelihood which isolates one of them.</p>
</div>
</div>
<p>Can we derive a technique that generates marginal densities from a <em>joint density</em>? Turns out we (perhaps surprisingly) can, using the <em>Metropolis-Hastings algorithm</em>.</p>
<section id="target-density" class="level3" data-number="9.1.1">
<h3 data-number="9.1.1" class="anchored" data-anchor-id="target-density"><span class="header-section-number">9.1.1</span> Target density</h3>
<p>We’ll derive the simplest posterior density that we can use in an exercise, but we begin with a more general case. Consider a posterior likelihood that is the product of a likelihood and <span class="math inline">\(k\)</span> prior densities, say <span class="math display">\[\begin{equation}
\mathcal{H}(\theta\ | \ y) = \mathcal{L}(\theta\ | \ y)\times \mathcal{P}_1(\theta_1)\times \mathcal{P}_2(\theta_2)\times \mathcal{P}_3(\theta_3)\times ...\times \mathcal{P}_k(\theta_k)
\end{equation}\]</span> This is the <em>target density</em>. How can we estimate the densities of the underlying <span class="math inline">\(\theta_i\)</span> from this posterior alone? This (somewhat amazingly) turns out to be rather simple.</p>
<p>The trick is to simulate draws for all the elements of <span class="math inline">\(\theta\)</span> from the target density – despite not having a generating function to draw from the density – and then estimating the marginal densities from the resulting series.</p>
</section>
</section>
<section id="simplified-problem-estimating-known-prior" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="simplified-problem-estimating-known-prior"><span class="header-section-number">9.2</span> Simplified problem: estimating (known) prior</h2>
<p>As the aim is to introduce MH in as simple a context as possible, we will sample from a posterior distribution for which we don’t have an appropriate random number generator but for marginal distributions that we do. This means we can compare analytical and estimated results.</p>
<p>We will try an estimate the marginal distributions for the priors alone; essentially <span class="math inline">\(\mathcal{H}(\theta\ | \ y)\)</span> where <span class="math inline">\(\mathcal{L}(y\ |\ \theta)\)</span> is flat for all values of the prior so <span class="math display">\[\begin{equation}
\mathcal{H}(\theta\ | \ y) = \mathcal{P}_1(\theta_1)\times \mathcal{P}_2(\theta_2)\times \mathcal{P}_3(\theta_3)\times ...\times \mathcal{P}_k(\theta_k)
\end{equation}\]</span> This means we know what the marginals should look like – they are just the priors!</p>
<p>Assume there are <span class="math inline">\(k\)</span> unknown parameters with a prior density set by the investigator, such as <span class="math display">\[\begin{equation}
  \mathcal{P}(\rho_1) \sim \text{Beta}(1.2,1.8)
\end{equation}\]</span> subject to the arbitrary bounds that <span class="math inline">\(0.001 &lt; \rho_1 &lt;0.999\)</span>.</p>
<p>We have <span class="math inline">\(k\)</span> of these, so in any code we could specify this in a matrix where each prior is specified in a row containing a name, a PDF type, the parameters of the PDF, as well as a lower and upper bound.</p>
</section>
<section id="example-1" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="example-1"><span class="header-section-number">9.3</span> Example 1</h2>
<p>First example: target density is the product of six parameters densities of four types: Normal, Gamma, Inverse Gamma and Beta. Any suitable density could be used as a prior, so the Uniform, say, or the Inverse Weibull or Log Gamma could be slotted in – and we will later on. All that is required is that the some function exists to evaluate the density. Obviously we could generalize this to one or three or more parameter distributions with appropriate code.</p>
<p>For example we could fit a Skew-<span class="math inline">\(t\)</span> say, as long as we can evaluate the (log) density for this 4 parameter distribution. See <span class="citation" data-cites="LossModels">Klugman, Panjer, and Willmot (<a href="references.html#ref-LossModels" role="doc-biblioref">2008</a>)</span> for a very comprehensive list of densities we could use – I cannot recommend this highly enough.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">

<table class="table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
name
</th>
<th style="text-align:right;">
lb
</th>
<th style="text-align:right;">
ub
</th>
<th style="text-align:left;">
PDF
</th>
<th style="text-align:right;">
p1
</th>
<th style="text-align:right;">
p2
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
beta
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:right;">
0.999
</td>
<td style="text-align:left;">
beta
</td>
<td style="text-align:right;">
2.3
</td>
<td style="text-align:right;">
1.200
</td>
</tr>
<tr>
<td style="text-align:left;">
rho[1]
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:right;">
0.999
</td>
<td style="text-align:left;">
beta
</td>
<td style="text-align:right;">
1.2
</td>
<td style="text-align:right;">
1.800
</td>
</tr>
<tr>
<td style="text-align:left;">
kappa
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:right;">
3.000
</td>
<td style="text-align:left;">
gamma
</td>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
4.000
</td>
</tr>
<tr>
<td style="text-align:left;">
mu
</td>
<td style="text-align:right;">
-5.000
</td>
<td style="text-align:right;">
1.000
</td>
<td style="text-align:left;">
norm
</td>
<td style="text-align:right;">
-2.0
</td>
<td style="text-align:right;">
0.550
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma[1]
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:right;">
5.000
</td>
<td style="text-align:left;">
invgamma
</td>
<td style="text-align:right;">
12.0
</td>
<td style="text-align:right;">
0.050
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma[2]
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:right;">
5.000
</td>
<td style="text-align:left;">
invgamma
</td>
<td style="text-align:right;">
9.0
</td>
<td style="text-align:right;">
0.075
</td>
</tr>
</tbody>

</table>
<p>Parameters of six densities used in Example 1</p>
</div>
</div>
<section id="analytic-densities" class="level3" data-number="9.3.1">
<h3 data-number="9.3.1" class="anchored" data-anchor-id="analytic-densities"><span class="header-section-number">9.3.1</span> Analytic densities</h3>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="SMH_files/figure-html/theoretical-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Plots of the theoretical densities given parameters in Table</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="random-draws" class="level3" data-number="9.3.2">
<h3 data-number="9.3.2" class="anchored" data-anchor-id="random-draws"><span class="header-section-number">9.3.2</span> Random draws</h3>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="SMH_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">True density known so we can draw from an appropriate random number generator</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="estimating-the-marginals-from-the-joint-density" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="estimating-the-marginals-from-the-joint-density"><span class="header-section-number">9.4</span> Estimating the marginals from the joint density</h2>
<p>First we need to understand the estimation procedure. The MH algorithm uses only information from the posterior to estimate the marginal processes that generated it, in stark contrast with Gibbs Sampling that uses conditional densities to approximate the unconditional one and then back out the marginals.</p>
<section id="metropolis-hastings" class="level3" data-number="9.4.1">
<h3 data-number="9.4.1" class="anchored" data-anchor-id="metropolis-hastings"><span class="header-section-number">9.4.1</span> Metropolis-Hastings</h3>
<p>A thorough explanation can be found in <span class="citation" data-cites="Chib">(<a href="references.html#ref-Chib" role="doc-biblioref"><strong>Chib?</strong></a>)</span> or <span class="citation" data-cites="BDA">(<a href="references.html#ref-BDA" role="doc-biblioref"><strong>BDA?</strong></a>)</span>, and here we describe the procedure without proof. Our aim is to draw samples from some distribution <span class="math display">\[
\mathcal{H}(\theta)
\]</span> where a direct approach is not feasible, because we don’t have a random number generator. The Metropolis-Hastings algorithm requires that we can evaluate this posterior density at some arbitrary points. As the form of the marginals is (potentially) unknown, we draw values from some arbitrary density and decide whether it looks like it came from the marginals that generated the posterior. <span class="math inline">\(\mathcal{H}(\theta)\)</span> is typically the posterior density where this distribution is far too complex to directly sample.</p>
<p>This indirect approach is to specify a <em>candidate density</em> <span class="math display">\[
  q(\theta^{k+1}|\theta^k)
\]</span> from which we <em>can</em> make candidate draws. Given some value for the parameters <span class="math inline">\(\theta^k\)</span>, we can randomly generate new values, which may or may not be independent of this draws.</p>
<p>The MH algorithm requires that we are able to evaluate <span class="math inline">\(\frac{H(\theta^{k+1})}{H(\theta^k)}\)</span>, and then draw a <em>candidate</em> value <span class="math inline">\(\theta^{k+1}\)</span> from <span class="math inline">\(q(\theta^{k+1}|\theta^k)\)</span>. We then accept this candidate value with the probability <span class="math display">\[
  \alpha = \min \left(\frac{H(\theta^{k+1})/q(\theta^{k+1}|\theta^k)}{H(\theta^k)/q(\theta^k|\theta^{k+1})}, 1\right)
\]</span> Practically, this requires we compute <span class="math inline">\(\alpha\)</span> and draw a number <span class="math inline">\(u\)</span> from <span class="math inline">\(U(0,1)\)</span>, and if <span class="math inline">\(u&lt;\alpha\)</span> accept <span class="math inline">\(\theta^{k+1}\)</span> otherwise keep <span class="math inline">\(\theta^k\)</span>.</p>
</section>
<section id="simplification" class="level3" data-number="9.4.2">
<h3 data-number="9.4.2" class="anchored" data-anchor-id="simplification"><span class="header-section-number">9.4.2</span> Simplification</h3>
<p>The <em>random walk</em> version of the algorithm takes the specific candidate density <span class="math inline">\(q(\theta^{k+1}|\theta^k)\)</span> as<br>
<span class="math display">\[
\theta^{k+1} = \theta^k + \epsilon_t
\]</span> where <span class="math inline">\(\epsilon_t\sim N(0,\Sigma)\)</span> for some <span class="math inline">\(\Sigma\)</span> which we need to choose. This is a simple vector-random walk. Let <span class="math inline">\(\theta^k\)</span> be some existing draw and <span class="math inline">\(\theta^{k+1}\)</span> be a new draw. We can write <span class="math display">\[
  \epsilon_t = \theta^{k+1}-\theta^k
\]</span> then <span class="math display">\[
  P(\epsilon_t) = P(\theta^{k+1}-\theta^k)
\]</span></p>
<p>Because this is a normal density (which is symmetric) then<br>
<span class="math display">\[
  P(\epsilon_t) = P(-\epsilon_t)
\]</span> Symmetry implies an acceptance probability of<br>
<span class="math display">\[
  \frac{H(\theta^{k+1})}{H(\theta^k)}
\]</span> as <span class="math inline">\(q(\theta^{k+1}|\theta^k) = q(\theta^k|\theta^{k+1})\)</span> so these terms cancel.</p>
<section id="algorithm" class="level4" data-number="9.4.2.1">
<h4 data-number="9.4.2.1" class="anchored" data-anchor-id="algorithm"><span class="header-section-number">9.4.2.1</span> Algorithm</h4>
<div>
<p><strong>Step 1</strong> Draw a <em>candidate</em> value <span class="math inline">\(\theta^{G+1}\)</span> from <span class="math inline">\(q(\theta^{k+1}|\theta^k)\)</span>, specifically <span class="math inline">\(\theta^{k+1} = \theta^k + \epsilon_t\)</span> where <span class="math inline">\(\epsilon_t\sim N(0,\Sigma)\)</span></p>
<p><strong>Step 2</strong> Compute the acceptance probability <span class="math display">\[
  \alpha = \min \left(\frac{H(\theta^{k+1})}{H(\theta^k)}, 1\right)
\]</span></p>
<p><strong>Step 3</strong> If <span class="math inline">\(u\sim U(0,1)\)</span> is less than <span class="math inline">\(\alpha\)</span>, keep <span class="math inline">\(\theta^{k+1}\)</span>, else repeat <span class="math inline">\(\theta^k\)</span> and discard the new draw</p>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>The density <span class="math inline">\(\mathcal{H}(\theta)\)</span> will usually be a posterior, combining the priors and likelihood information;</li>
<li>At present we have no likelihood information, so all we need is a function to evaluate the (log) joint prior.</li>
</ul>
</div>
</div>
</section>
</section>
</section>
<section id="a-simpler-problem" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="a-simpler-problem"><span class="header-section-number">9.5</span> A simpler problem</h2>
<p>We have no data (or indeed model) to pass to the posterior function (as there is no likelihood). Generalizing this to incorporate likelihood information is straightforward.</p>
<p>We need to specify the scale of the random walk: assume <span class="math display">\[
  \Sigma = sI
\]</span> We should choose a value of <span class="math inline">\(s\)</span> to ensure that the whole parameter space is explored as</p>
<ul>
<li>if <span class="math inline">\(s\)</span> too small we don’t walk far enough, and stay too close to potentially only local maxima;</li>
<li>if <span class="math inline">\(s\)</span> too large may jump over highest density points at every step and take a long time to converge.</li>
</ul>
<p>We check if it is a suitable value by monitoring the acceptance rate: between about 1/5 and 2/5 fine.</p>
<section id="estimating-example-1" class="level3" data-number="9.5.1">
<h3 data-number="9.5.1" class="anchored" data-anchor-id="estimating-example-1"><span class="header-section-number">9.5.1</span> Estimating example 1</h3>
<p>Choose some arbitrary initial values at which we can evaluate our posterior likelihood (remembering for this example this only the joint prior). These are 0.9, 0.2, 0.4, -2, 1.5, 1.5. As we have chosen values close to the highest density this evaluates as 0.425433. We choose <span class="math inline">\(s=0.25\)</span> and do 100000 iterations and discard the first half. For the run that generates the graphs below we get the message:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Acceptance ratio: 0.33282"</code></pre>
</div>
</div>
<p>The acceptance ratio is good, so we plot the draws:</p>
<div class="cell" data-layout-align="center" data-fig-cap-location="margin">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="SMH_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Plots of the 50,000 draws</figcaption>
</figure>
</div>
</div>
</div>
<p>or just the first few to better see the algorithm in action:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="SMH_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Plots of first 333 draws</figcaption>
</figure>
</div>
</div>
</div>
<p>Clearly there are some repeat values. What do the estimated densiites from each of these sequences look like?</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="SMH_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Histograms of draws and theoretical priors</figcaption>
</figure>
</div>
</div>
</div>
<p>Pretty good! Compare this with the sequence of draws we got from the correct random number generators for each density.</p>
</section>
<section id="example-2" class="level3" data-number="9.5.2">
<h3 data-number="9.5.2" class="anchored" data-anchor-id="example-2"><span class="header-section-number">9.5.2</span> Example 2</h3>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">

<table class="table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
name
</th>
<th style="text-align:right;">
lb
</th>
<th style="text-align:right;">
ub
</th>
<th style="text-align:left;">
PDF
</th>
<th style="text-align:right;">
p1
</th>
<th style="text-align:right;">
p2
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
eta
</td>
<td style="text-align:right;">
0.250
</td>
<td style="text-align:right;">
5.000
</td>
<td style="text-align:left;">
invweibull
</td>
<td style="text-align:right;">
2.3
</td>
<td style="text-align:right;">
1.2
</td>
</tr>
<tr>
<td style="text-align:left;">
zeta[1]
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:right;">
6.000
</td>
<td style="text-align:left;">
paralogis
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
4.0
</td>
</tr>
<tr>
<td style="text-align:left;">
zeta[2]
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:right;">
3.000
</td>
<td style="text-align:left;">
paralogis
</td>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
3.0
</td>
</tr>
<tr>
<td style="text-align:left;">
delta
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:right;">
5.000
</td>
<td style="text-align:left;">
invpareto
</td>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
0.3
</td>
</tr>
<tr>
<td style="text-align:left;">
alpha[1]
</td>
<td style="text-align:right;">
1.001
</td>
<td style="text-align:right;">
5.000
</td>
<td style="text-align:left;">
lgamma
</td>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
5.0
</td>
</tr>
<tr>
<td style="text-align:left;">
alpha[2]
</td>
<td style="text-align:right;">
1.001
</td>
<td style="text-align:right;">
5.000
</td>
<td style="text-align:left;">
lgamma
</td>
<td style="text-align:right;">
3.0
</td>
<td style="text-align:right;">
4.0
</td>
</tr>
<tr>
<td style="text-align:left;">
upsilon[1]
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:right;">
0.999
</td>
<td style="text-align:left;">
unif
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.7
</td>
</tr>
<tr>
<td style="text-align:left;">
upsilon[2]
</td>
<td style="text-align:right;">
0.001
</td>
<td style="text-align:right;">
0.999
</td>
<td style="text-align:left;">
unif
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
</tbody>

</table>
<p>All-different distributions – Inverse Weibull, Paralogistic, Inverse Pareto, Log Gamma and Uniform</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="SMH_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Plots of the theoretical densities given parameters in Table 2</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="SMH_files/figure-html/MHcall2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Walk a little less <span class="math inline">\(s=0.125\)</span> (could iterate a little more?)</figcaption>
</figure>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-LossModels" class="csl-entry" role="listitem">
Klugman, Stuart A., Harry H. Panjer, and Gordon E. Willmot. 2008. <em>Loss Models: From Data to Decisions</em>. Third. Hoboken, N.J.: John Wiley &amp; Sons, Inc.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./CK.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Carter-Kohn</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Stemp.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Causal Inference</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>